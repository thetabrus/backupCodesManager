<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backup Codes Manager</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      textarea,
      input,
      button,
      fieldset {
        font-family: sans-serif;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-bottom: 10px;
      }
      fieldset {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .section-header {
        display: flex;
        align-items: center;
        font-weight: bold;
        margin-top: 16px;
      }
      .section-header input[type="checkbox"] {
        margin-right: 8px;
      }
      input[type="text"] {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
        margin-bottom: 8px;
      }
      .codes-container {
        margin: 8px 0;
      }
      .code-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
      }
      .code-item input[type="checkbox"] {
        margin-right: 8px;
      }
      .code-item input[type="text"] {
        flex: 1;
        padding: 4px;
        margin-right: 8px;
      }
      .code-item button {
        padding: 4px 8px;
      }
      #addCodeBtn {
        margin: 8px 0;
      }
      .master-check {
        display: flex;
        align-items: center;
        margin: 16px 0;
        font-weight: bold;
      }
      .master-check input[type="checkbox"] {
        margin-right: 8px;
      }
      button {
        padding: 8px 16px;
        margin-right: 10px;
        font-size: 1rem;
        cursor: pointer;
      }
      .error {
        color: red;
        margin-bottom: 12px;
        display: block;
      }
      @media print {
        body {
          margin: 0;
        }
        .block {
          width: 105mm;
          height: 74mm;
          box-sizing: border-box;
          padding: 8mm;
          page-break-after: always;
        }
        .block input[type="checkbox"] {
          transform: scale(1.2);
          margin-right: 6px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Backup 2FA Codes Manager</h1>
    <div id="rawSection">
      <p>Paste the raw text with the list of backup codes:</p>
      <textarea id="rawInput" placeholder="Paste raw text..."></textarea>
      <span
        id="rawInputError"
        class="error"
        style="display: none; margin-bottom: 5px"
      ></span>
      <button id="parseBtn">Parse and Edit</button>
    </div>
    <form id="editForm" style="display: none">
      <fieldset>
        <legend>Original Text</legend>
        <textarea
          id="previewRaw"
          readonly
          style="width: 100%; height: 100px"
        ></textarea>
      </fieldset>
      <fieldset>
        <legend>Print Data</legend>
        <div class="section-header">
          <input type="checkbox" id="checkService" /><label for="serviceInput"
            >Service Name</label
          >
        </div>
        <input type="text" id="serviceInput" />
        <div class="section-header">
          <input type="checkbox" id="checkLogin" /><label for="loginInput"
            >Email/Login</label
          >
        </div>
        <input type="text" id="loginInput" />
        <div class="section-header">
          <input type="checkbox" id="checkAllCodes" /><label
            >List of Codes</label
          >
        </div>
        <div class="codes-container" id="codesContainer"></div>
        <button type="button" id="addCodeBtn">+ Add Code</button>
        <div class="section-header">
          <input type="checkbox" id="checkNote" /><label for="noteInput"
            >Note</label
          >
        </div>
        <input type="text" id="noteInput" />
        <div class="section-header">
          <input type="checkbox" id="checkDate" /><label for="dateInput"
            >Date</label
          >
        </div>
        <input type="text" id="dateInput" />
        <div class="master-check">
          <input type="checkbox" id="checkAllFields" /><label
            for="checkAllFields"
            >All sections and codes checked</label
          >
        </div>
        <span id="errorMsg" class="error"></span>
        <button type="button" id="printBtn">Print</button>
        <button type="button" id="downloadJsonBtn">Download JSON</button>
        <button type="button" id="cancelBtn">Cancel</button>
      </fieldset>
    </form>
    <script>
      const sectionIds = [
        "checkService",
        "checkLogin",
        "checkNote",
        "checkDate",
      ];
      function updateCodeMaster() {
        const codeChecks = document.querySelectorAll(".code-check");
        const masterCodes = document.getElementById("checkAllCodes");
        masterCodes.checked =
          codeChecks.length > 0 &&
          Array.from(codeChecks).every((c) => c.checked);
        updateFormMaster();
      }
      function updateFormMaster() {
        const sectionsOk = sectionIds.every(
          (id) => document.getElementById(id).checked
        );
        const codeChecks = document.querySelectorAll(".code-check");
        const codesOk =
          codeChecks.length > 0 &&
          Array.from(codeChecks).every((c) => c.checked);
        document.getElementById("checkAllFields").checked =
          sectionsOk && codesOk;
      }
      function bindSectionCheckboxes() {
        sectionIds.concat("checkAllCodes").forEach((id) => {
          document.getElementById(id).addEventListener("change", () => {
            if (id === "checkAllCodes") {
              const checked = document.getElementById("checkAllCodes").checked;
              document
                .querySelectorAll(".code-check")
                .forEach((c) => (c.checked = checked));
            }
            updateFormMaster();
          });
        });
      }
      function createCodeRow(val = "") {
        const div = document.createElement("div");
        div.className = "code-item";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "code-check";
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = val;
        const del = document.createElement("button");
        del.type = "button";
        del.textContent = "âœ–";
        del.addEventListener("click", () => {
          div.remove();
          updateCodeMaster();
        });
        chk.addEventListener("change", updateCodeMaster);
        div.append(chk, inp, del);
        return div;
      }
      function addCode(val = "") {
        const row = createCodeRow(val);
        document.getElementById("codesContainer").appendChild(row);
        updateCodeMaster();
      }
      document
        .getElementById("addCodeBtn")
        .addEventListener("click", () => addCode(""));
      document
        .getElementById("checkAllFields")
        .addEventListener("change", (e) => {
          const checked = e.target.checked;
          sectionIds
            .concat("checkAllCodes")
            .forEach((id) => (document.getElementById(id).checked = checked));
          document
            .querySelectorAll(".code-check")
            .forEach((c) => (c.checked = checked));
        });
      // Regex to find codes: alphanumeric with at least one digit, supporting Unicode letters (diacritics).
      // Handles precomposed and decomposed Unicode characters (e.g., letter + combining marks).
      // Using lookarounds for boundaries due to potential \b issues with some Unicode sequences.
      const CODE_REGEX =
        /(?:(?<=^)|(?<=[^\p{L}\p{N}_]))(?=.*\d)(?:[\p{L}0-9]\p{M}*){4,}(?:[ -](?:[\p{L}0-9]\p{M}*){4,})*(?:(?=$)|(?=[^\p{L}\p{N}_]))/gu;
      function parseRaw(raw) {
        const lines = raw.split(/\r?\n/);
        let service = "",
          login = "",
          note = "",
          dateText = "",
          codes = [];
        lines.forEach((l) => {
          let t = l.trim();
          if (!t) return;
          t = t.replace(/^\d+\.[ \t]*/, "").trim();
          if (/\b(?:wygenerowano|generated)[:]?/i.test(t)) {
            dateText = t.split(/[:]/).slice(1).join(":").trim();
            return;
          }
          if (/^\S+@\S+\.\S+$/.test(t) || /^\(.+@.+\)$/.test(t)) {
            login = t.replace(/^[()]+|[()]+$/g, "");
            return;
          }
          if (/^[*\-]\s/.test(t)) {
            note += t.replace(/^[*\-]\s*/, "") + " ";
            return;
          }
          const found = t.match(CODE_REGEX);
          if (found) {
            found.forEach((tok) => codes.push(tok.trim()));
            return;
          }
          if (!service && t.length < 50) {
            service = t;
          }
        });
        if (!dateText) dateText = new Date().toLocaleDateString();
        return { service, login, note: note.trim(), date: dateText, codes };
      }
      document.getElementById("parseBtn").addEventListener("click", () => {
        const raw = document.getElementById("rawInput").value;
        const rawInputError = document.getElementById("rawInputError");

        if (!raw.trim()) {
          rawInputError.textContent = "Please paste the raw text.";
          rawInputError.style.display = "block";
          return;
        }
        rawInputError.textContent = "";
        rawInputError.style.display = "none";

        const data = parseRaw(raw);
        document.getElementById("previewRaw").value = raw;
        ["service", "login", "note", "date"].forEach(
          (f) => (document.getElementById(f + "Input").value = data[f])
        );
        document.getElementById("codesContainer").innerHTML = "";
        data.codes.forEach((c) => addCode(c));
        [
          "checkService",
          "checkLogin",
          "checkAllCodes",
          "checkNote",
          "checkDate",
          "checkAllFields",
        ].forEach((id) => (document.getElementById(id).checked = false));
        document.getElementById("errorMsg").textContent = "";
        document.getElementById("rawSection").style.display = "none";
        document.getElementById("editForm").style.display = "block";
        bindSectionCheckboxes();
        updateCodeMaster();
      });
      document.getElementById("cancelBtn").addEventListener("click", () => {
        document.getElementById("editForm").style.display = "none";
        document.getElementById("rawSection").style.display = "block";
        document.getElementById("errorMsg").textContent = "";
        document.getElementById("rawInputError").textContent = "";
        document.getElementById("rawInputError").style.display = "none";
      });
      document.getElementById("printBtn").addEventListener("click", () => {
        const err = document.getElementById("errorMsg");
        err.textContent = "";
        if (!document.getElementById("checkAllFields").checked) {
          err.textContent =
            "Please confirm that all sections and codes have been checked.";
          return;
        }
        const srv = document.getElementById("serviceInput").value;
        const log = document.getElementById("loginInput").value;
        const notes = document.getElementById("noteInput").value;
        const dat = document.getElementById("dateInput").value;
        const items = Array.from(document.querySelectorAll(".code-item")).map(
          (d) => d.querySelector("input[type=text]").value
        );
        const codesHtml = items
          .map(
            (v) => `<li><input type=\"checkbox\" disabled checked> ${v}</li>`
          )
          .join("");
        const block = `<div class=\"block\"><h2>${srv}</h2><p><strong>${log}</strong></p><ul>${codesHtml}</ul>${
          notes ? `<p><em>${notes}</em></p>` : ""
        }<p class=\"date\">${dat}</p></div>`;
        const win = window.open("", "_blank");
        win.document.write(
          `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print Codes</title><style>
body {
  font-family: sans-serif;
  margin: 0;
  background-color: #f0f0f0; /* Preview background */
  display: flex; /* Center content in preview */
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}
.block {
  width: 140mm; /* Approx. A5 landscape width */
  height: 190mm; /* Approx. A5 landscape height */
  box-sizing: border-box;
  border: 1px solid #444;
  padding: 10mm;
  font-size: 10pt; /* Base font size for the block */
  background-color: white; /* White card background for preview */
  box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Subtle shadow for preview */
  overflow: hidden; /* Prevent content spill in preview */
}
.block h2 { font-size: 1.8em; margin-top: 0; margin-bottom: 0.6em; color: #333; font-weight: bold;}
.block p { font-size: 1em; margin: 0.6em 0; line-height: 1.4; }
.block p strong { color: #000; font-weight: bold; } /* For login */
.block ul { font-size: 1em; padding-left: 0; margin: 0.8em 0; list-style-type: none; }
.block li { margin-bottom: 0.5em; display: flex; align-items: center; }
.block li input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; flex-shrink: 0; }
.block .date { font-size: 0.9em; color: #555; margin-top: 1em; text-align: right; }
.block em { color: #444; font-style: italic; } /* For notes */

@media print {
  body { background-color: transparent; display: block; min-height: auto; margin:0; }
  .block { margin: 0; page-break-after: always; box-shadow: none; } /* Align to top-left for printing */
}
</style></head><body>${block}<script>window.print()<\/script></body></html>`
        );
      });
      document
        .getElementById("downloadJsonBtn")
        .addEventListener("click", () => {
          const srv = document.getElementById("serviceInput").value.trim();
          const log = document.getElementById("loginInput").value.trim();
          const notes = document.getElementById("noteInput").value.trim();
          const dat = document.getElementById("dateInput").value.trim();
          const items = Array.from(
            document.querySelectorAll(".code-item input[type=text]")
          ).map((input) => input.value.trim());

          const jsonData = {
            serviceName: srv,
            login: log,
            codes: items,
            note: notes,
            date: dat,
            originalRawInput: document.getElementById("previewRaw").value,
          };

          const jsonString = JSON.stringify(jsonData, null, 2); // null, 2 for pretty printing
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${srv || "backup-codes"}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
    </script>
  </body>
</html>
